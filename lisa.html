<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Lisa Martingano – Laur. Plut. 23 sin.4</title>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <div id="tei-container"></div>
    <script type="module">
        async function loadTEI(fileName, targetSelector) {
            const target = document.querySelector(targetSelector);
            if (!target) throw new Error("Target element not found: " + targetSelector);

            try {
            const res = await fetch(`${fileName}`, { headers: { "Accept": "application/xml" } });
            if (!res.ok) throw new Error(`HTTP ${res.status} for ${fileName}`);
            const xmlText = await res.text();

            // Parse XML (TEI usually uses a default namespace)
            const parser = new DOMParser();
            const xml = parser.parseFromString(xmlText, "application/xml");

            // Basic parse error check
            if (xml.getElementsByTagName("parsererror").length) {
                throw new Error("XML parse error");
            }

            // Render TEI → HTML
            const html = teiNodeToHTML(xml.documentElement);
            target.innerHTML = "";
            target.appendChild(html);
            } catch (err) {
            console.error(err);
            // Fallback: show raw XML safely
            target.textContent = "Failed to render TEI. Showing raw XML:\n\n" + (err?.message || "");
            try {
                const res2 = await fetch(`${fileName}`);
                const raw = await res2.text();
                target.textContent += "\n\n" + raw;
            } catch {}
            }
        }

        // Minimal TEI → HTML mapping
        function teiNodeToHTML(node) {
            // Text nodes
            if (node.nodeType === Node.TEXT_NODE) {
            return document.createTextNode(node.nodeValue);
            }

            // Ignore comments and processing instructions
            if (node.nodeType !== Node.ELEMENT_NODE) {
            return document.createDocumentFragment();
            }

            const name = node.localName; // works regardless of TEI namespace
            const frag = document.createDocumentFragment();

            // Helper to render children
            const renderChildren = (parentEl = null) => {
            const container = parentEl || document.createDocumentFragment();
            for (const child of node.childNodes) {
                container.appendChild(teiNodeToHTML(child));
            }
            return container;
            };

            // Map a few common TEI elements
            switch (name) {
            case "TEI":
            case "teiCorpus": {
                const wrapper = el("article", "tei-doc");
                wrapper.appendChild(renderChildren());
                return wrapper;
            }
            case "teiHeader": {
                // Skip header in main view but keep title if present
                const titleStmt = node.getElementsByTagNameNS("*", "titleStmt")[0];
                const titleEl = titleStmt?.getElementsByTagNameNS("*", "title")[0];
                if (titleEl) {
                const h1 = el("h1");
                h1.textContent = textContentDeep(titleEl);
                return h1;
                }
                return document.createDocumentFragment();
            }
            case "text": {
                const section = el("section");
                section.appendChild(renderChildren());
                return section;
            }
            case "body": {
                const main = el("div", "tei-body");
                main.appendChild(renderChildren());
                return main;
            }
            case "div": {
                const div = el("section", "tei-div");
                // optional head within div
                const head = node.getElementsByTagNameNS("*", "head")[0];
                if (head) {
                const h2 = el("h2");
                h2.textContent = textContentDeep(head);
                div.appendChild(h2);
                }
                for (const child of node.childNodes) {
                if (child.nodeType === Node.ELEMENT_NODE && child.localName === "head") continue;
                div.appendChild(teiNodeToHTML(child));
                }
                return div;
            }
            case "p": {
                const p = el("p");
                p.appendChild(renderChildren());
                return p;
            }
            case "head": {
                const h2 = el("h2");
                h2.appendChild(renderChildren());
                return h2;
            }
            case "lb": {
                return el("br");
            }
            case "pb": {
                const span = el("span", "tei-pb");
                span.setAttribute("title", "Page break");
                span.append(" | ");
                return span;
            }
            case "note": {
                const aside = el("aside", "tei-note");
                aside.appendChild(renderChildren());
                return aside;
            }
            case "hi": {
                const rend = node.getAttribute("rend") || "";
                const tag = /italic|em/.test(rend) ? "em" : /bold|strong/.test(rend) ? "strong" : "span";
                const elx = el(tag);
                elx.appendChild(renderChildren());
                return elx;
            }
            case "q": {
                const q = el("blockquote");
                q.appendChild(renderChildren());
                return q;
            }
            case "list": {
                const listType = node.getAttribute("type") || "";
                const ul = el(listType === "ordered" ? "ol" : "ul");
                ul.appendChild(renderChildren());
                return ul;
            }
            case "item": {
                const li = el("li");
                li.appendChild(renderChildren());
                return li;
            }
            case "lg": {
                const div = el("div", "tei-lg");
                div.appendChild(renderChildren());
                return div;
            }
            case "l": {
                const p = el("p", "tei-line");
                p.appendChild(renderChildren());
                return p;
            }
            case "ref": {
                const a = el("a");
                const href = node.getAttribute("target") || node.getAttribute("url") || "#";
                a.href = href;
                a.appendChild(renderChildren());
                return a;
            }
            default: {
                // Unknown TEI element: render its children inline
                return renderChildren();
            }
            }
        }

        // Utilities
        function el(tag, className) {
            const e = document.createElement(tag);
            if (className) e.className = className;
            return e;
        }
        function textContentDeep(node) {
            let s = "";
            const walker = document.createTreeWalker(node, NodeFilter.SHOW_TEXT, null);
            let n;
            while ((n = walker.nextNode())) s += n.nodeValue;
            return s.trim();
        }

        // Call it with your file name and target container
        // Example: a file at ./your_name/your_name.xml → render into #tei-container
        loadTEI("./lisa/lisa.xml", "#tei-container");
    </script>

    <style>
    /* Minimal styling */
    .tei-doc { line-height: 1.6; }
    .tei-note { font-size: 0.95em; padding-left: 0.8rem; border-left: 3px solid #ddd; margin: 0.5rem 0; }
    .tei-pb { opacity: 0.6; font-size: 0.9em; }
    .tei-div { margin: 1rem 0; }
    .tei-line { margin: 0; }
    </style>

  </body>
</html>
